generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model User {
  id               String        @id @default(uuid())
  email            String        @unique
  password         String
  name             String
  createdAt        DateTime      @default(now()) @map("created_at")
  plan             UserPlan      @default(FREE)
  avatars          Json?         @map("avatars")
  files            MediaFile[]   @relation("UserFiles")
  sentAccesses     BlockAccess[] @relation("SentAccess")
  receivedAccesses BlockAccess[] @relation("ReceivedAccess")

  @@map("users")
}

model MediaFile {
  id           String     @id @default(uuid())
  bucket       String
  key          String
  originalName String     @map("original_name")
  mimeType     String     @map("mime_type")
  size         Int
  ownerId      String
  access       FileAccess @default(PRIVATE)
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  owner        User       @relation("UserFiles", fields: [ownerId], references: [id])

  @@index([ownerId])
  @@index([mimeType])
  @@map("media_files")
}

model Block {
  id            String               @id
  type          BlockType
  meta          Json?
  path          Unsupported("ltree")
  order         Int
  createdAt     DateTime             @default(now()) @map("created_at")
  updatedAt     DateTime             @updatedAt @map("updated_at")
  blockAccesses BlockAccess[]

  @@index([path], map: "blocks_path_gist_idx", type: Gist)
  @@map("blocks")
}

model BlockAccess {
  id       String               @id @default(uuid())
  fromId   String?              @map("from_id")
  toId     String               @map("to_id")
  blockId  String               @map("block_id")
  rootPath Unsupported("ltree") @map("root_path")

  permission BlockPermission @default(VIEW)
  isActive   Boolean         @default(true) @map("is_active")
  expiresAt  DateTime?       @map("expires_at")
  createdAt  DateTime        @default(now()) @map("created_at")
  updatedAt  DateTime        @updatedAt @map("updated_at")

  fromUser User? @relation("SentAccess", fields: [fromId], references: [id])
  toUser   User  @relation("ReceivedAccess", fields: [toId], references: [id])
  block    Block @relation(fields: [blockId], references: [id], onDelete: Cascade)

  @@unique([toId, blockId])
  @@index([fromId])
  @@index([toId])
  @@index([blockId])
  @@index([rootPath], type: Gist)
  @@index([expiresAt])
  @@index([isActive])
  @@map("block_accesses")
}

enum UserPlan {
  FREE
  PRO
  PREMIUM
}

enum FileAccess {
  PUBLIC
  PRIVATE
}

enum BlockPermission {
  OWNER
  EDIT
  VIEW
}

enum BlockType {
  TEXT
  PAGE
}
