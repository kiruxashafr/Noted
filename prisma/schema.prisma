generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String        @id @default(uuid())
  email         String        @unique
  password      String
  name          String
  createdAt     DateTime      @default(now()) @map("created_at")
  plan          UserPlan      @default(FREE)
  avatars       Json?         @map("avatars")
  blockAccesses BlockAccess[]
  files         MediaFile[]   @relation("UserFiles")

  @@map("users")
}

model MediaFile {
  id           String     @id @default(uuid())
  bucket       String
  key          String
  originalName String     @map("original_name")
  mimeType     String     @map("mime_type")
  size         Int
  ownerId      String
  access       FileAccess @default(PRIVATE)
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  owner        User       @relation("UserFiles", fields: [ownerId], references: [id])

  @@index([ownerId])
  @@index([mimeType])
  @@map("media_files")
}

model Block {
  id            String               @id
  type          BlockType
  meta          Json?
  path          Unsupported("ltree")
  order         Int
  createdAt     DateTime             @default(now()) @map("created_at")
  updatedAt     DateTime             @updatedAt @map("updated_at")
  blockAccesses BlockAccess[]

  @@index([path], map: "blocks_path_gist_idx", type: Gist)
  @@map("blocks")
}

model BlockAccess {
  id       String               @id @default(uuid())
  userId   String               @map("user_id")
  blockId  String               @map("block_id")
  rootPath Unsupported("ltree") @map("root_path")

  permission BlockPermission @default(VIEW)
  isActive   Boolean         @default(true)
  expiresAt  DateTime?       @map("expires_at")
  createdAt  DateTime        @default(now()) @map("created_at")
  updatedAt  DateTime        @updatedAt @map("updated_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  block Block @relation(fields: [blockId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([blockId])
  @@index([rootPath], type: Gist) // Индекс GiST для мгновенной проверки иерархии
  @@index([expiresAt])
  @@index([isActive])
  @@map("block_accesses")
}

enum UserPlan {
  FREE
  PRO
  PREMIUM
}

enum FileAccess {
  PUBLIC
  PRIVATE
}

enum BlockPermission {
  OWNER
  EDIT
  VIEW
}

enum BlockType {
  TEXT
  PAGE
}
